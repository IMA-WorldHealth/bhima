version: v1.0
name: Integration Tests
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu1804
blocks:
  - name: Update Dependencies
    task:
      jobs:
        - name: Update Dependencies
          commands:
            - sudo apt-get -y update && sudo apt-get install mysql-client redis-tools
            - echo "done"
  - name: Testing Matrix
    task:
      prologue:
        commands:
          - sem-service start redis
      env_vars:
        - name: DB_USER
          value: bhimasemaphore
        - name: DB_HOST
          value: 127.0.0.1
        - name: DB_PASSWORD
          value: 6a50c5ed121ac12b35b96cbb59b5
        - name: DB_PORT
          value: '3306'
        - name: DB_NAME
          value: bhima-semaphore
      jobs:
        - name: Run Test Matrix
          commands:
            - 'sem-service start mysql $MYSQL_VERSION --username=$DB_USER --password=$DB_PASSWORD --db=$DB_NAME --sql-mode="STRICT_ALL_TABLES,NO_UNSIGNED_SUBTRACTION"'
            - nvm install $NODEJS_VERSION
            - checkout
            - 'npm run build:db'
            - npm run build
            - 'npm run test:server-unit'
            - echo "done."
          matrix:
            - env_var: MYSQL_VERSION
              values:
                - '5.7'
                - '8'
            - env_var: NODEJS_VERSION
              values:
                - '12'
                - '14'
