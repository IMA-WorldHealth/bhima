version: 1.0.{build}

image:
  - Ubuntu2004
  - Ubuntu1804
  - Ubuntu1604

stack: mysql, redis

build: off

environment:
  matrix:
    - nodejs_version: 14
    - nodejs_version: 12

matrix:
  fast_finish: true

skip_branch_with_pr: true
clone_depth: 3

max_jobs: 5

install:
  - mysql --version
  - nvm install $nodejs_version
  - ./sh/setup-ci-env.sh
  - echo Outside DB_USER $DB_USER
  - echo Outside DB_HOST $DB_HOST
  - echo Outside DB_NAME $DB_NAME
  - echo Outside SESS_SECRET $SESS_SECRET
  - ./sh/appveyor.sh
  - yarn

services:
  - mysql
  - redis

test_script:
  - yarn build
  - yarn build:db
  - yarn test:server-unit
  - yarn test:client-unit
  - yarn test:integration
